name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    name: Release (${{ matrix.platform }})
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Validate changelog entry
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          VERSION_REGEX="$(printf '%s' "$VERSION" | sed -E 's/[][(){}.^$*+?|\\/]/\\&/g')"
          if ! grep -Eq "^## \[$VERSION_REGEX\]( |$)" CHANGELOG.md; then
            echo "Missing changelog entry for version $VERSION in CHANGELOG.md"
            echo "Expected a heading like: ## [$VERSION] - YYYY-MM-DD"
            exit 1
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Validate versions and prepare release notes
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          package_version="$(node -e "process.stdout.write(require('./package.json').version)")"
          tauri_version="$(node -e "const fs=require('fs');const cfg=JSON.parse(fs.readFileSync('./src-tauri/tauri.conf.json','utf8'));process.stdout.write(cfg.version)")"
          cargo_version="$(
            awk '
              /^\[package\]/{in_pkg=1; next}
              /^\[/{if (in_pkg) exit}
              in_pkg && /^version[[:space:]]*=/ {print; exit}
            ' src-tauri/Cargo.toml | sed -E 's/^version[[:space:]]*=[[:space:]]*"([^"]+)".*$/\1/'
          )"

          if [ -z "$package_version" ] || [ -z "$tauri_version" ] || [ -z "$cargo_version" ]; then
            echo "Failed to resolve all version fields."
            echo "package.json=$package_version tauri.conf.json=$tauri_version Cargo.toml=$cargo_version"
            exit 1
          fi

          if [ "$VERSION" != "$package_version" ] || [ "$VERSION" != "$tauri_version" ] || [ "$VERSION" != "$cargo_version" ]; then
            echo "Version mismatch detected."
            echo "tag=$VERSION package.json=$package_version tauri.conf.json=$tauri_version Cargo.toml=$cargo_version"
            exit 1
          fi

          awk -v v="$VERSION" '
            BEGIN { in_section=0; found=0 }
            $0 ~ "^## \\[" v "\\]" {
              in_section=1;
              found=1;
              print;
              next;
            }
            in_section && $0 ~ "^## \\[" { exit }
            in_section { print }
            END {
              if (!found) { exit 2 }
            }
          ' CHANGELOG.md > RELEASE_NOTES.md

          if [ ! -s RELEASE_NOTES.md ]; then
            echo "Generated RELEASE_NOTES.md is empty."
            exit 1
          fi

      - uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Build app bundle
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "windows-latest" ]; then
            npm run tauri -- build --bundles msi nsis
          else
            npm run tauri -- build --bundles app
          fi

      - name: Ad-hoc sign app bundle
        if: matrix.platform == 'macos-latest'
        shell: bash
        run: |
          APP_PATH="src-tauri/target/release/bundle/macos/VoiceDictation.app"
          codesign --force --deep --sign - "$APP_PATH"
          codesign --verify --deep --strict --verbose=4 "$APP_PATH"

      - name: Create DMG
        if: matrix.platform == 'macos-latest'
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          ARCH="$(uname -m)"
          if [ "$ARCH" = "arm64" ]; then
            ARCH_NAME="aarch64"
          else
            ARCH_NAME="x64"
          fi
          DMG_NAME="VoiceDictation_${VERSION}_${ARCH_NAME}.dmg"
          STAGING_DIR="$(mktemp -d)"
          cp -R "src-tauri/target/release/bundle/macos/VoiceDictation.app" "$STAGING_DIR/"
          ln -s /Applications "$STAGING_DIR/Applications"
          hdiutil create -volname "VoiceDictation" -srcfolder "$STAGING_DIR" -ov -format UDZO "$DMG_NAME"
          mkdir -p release-assets
          mv "$DMG_NAME" "release-assets/$DMG_NAME"

      - name: Normalize Windows artifact names
        if: matrix.platform == 'windows-latest'
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          mkdir -p release-assets
          for f in src-tauri/target/release/bundle/msi/*.msi src-tauri/target/release/bundle/nsis/*.exe; do
            [ -e "$f" ] || continue
            base="$(basename "$f")"
            normalized="$(printf '%s' "$base" | sed -E "s/[0-9]+\.[0-9]+\.[0-9]+/${VERSION}/g")"
            cp "$f" "release-assets/$normalized"
          done

          count="$(find release-assets -maxdepth 1 -type f | wc -l | tr -d ' ')"
          if [ "${count:-0}" -eq 0 ]; then
            echo "No Windows release assets were prepared."
            exit 1
          fi

      - name: Upload release (macOS)
        if: matrix.platform == 'macos-latest'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: "VoiceDictation ${{ github.ref_name }}"
          body_path: RELEASE_NOTES.md
          files: "release-assets/VoiceDictation_*.dmg"

      - name: Upload release (Windows)
        if: matrix.platform == 'windows-latest'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: "VoiceDictation ${{ github.ref_name }}"
          body_path: RELEASE_NOTES.md
          files: |
            release-assets/*.msi
            release-assets/*.exe

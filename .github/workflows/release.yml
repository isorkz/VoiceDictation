name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    name: Release (${{ matrix.platform }})
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Build app bundle
        run: npm run tauri -- build --bundles app

      - name: Ad-hoc sign app bundle
        run: |
          APP_PATH="src-tauri/target/release/bundle/macos/VoiceDictation.app"
          codesign --force --deep --sign - "$APP_PATH"
          codesign --verify --deep --strict --verbose=4 "$APP_PATH"

      - name: Create DMG
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          ARCH="$(uname -m)"
          if [ "$ARCH" = "arm64" ]; then
            ARCH_NAME="aarch64"
          else
            ARCH_NAME="x64"
          fi
          DMG_NAME="VoiceDictation_${VERSION}_${ARCH_NAME}.dmg"
          hdiutil create -volname "VoiceDictation" -srcfolder "src-tauri/target/release/bundle/macos/VoiceDictation.app" -ov -format UDZO "$DMG_NAME"

      - name: Upload release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: "VoiceDictation ${{ github.ref_name }}"
          body: "See CHANGELOG.md for details."
          files: "VoiceDictation_*.dmg"
